<view:UserTab
      x:Class="COTG.Views.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:tg="using:Telerik.UI.Xaml.Controls.Grid"
      xmlns:tk="using:Microsoft.Toolkit.Uwp.UI.Controls"
      xmlns:winui="using:Microsoft.UI.Xaml.Controls"
      xmlns:wwinui="using:Windows.UI.Xaml.Controls"
      xmlns:model="using:COTG.Models"
      xmlns:game="using:COTG.Game"
      xmlns:cotg="using:COTG"
      xmlns:view="using:COTG.Views"
      mc:Ignorable="d"
      Tag="Raid"
      Background="{x:Null}">
    <Grid x:Name="cityBaseGrid">
        <Grid.ColumnDefinitions>
            <ColumnDefinition />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="3*" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" VerticalAlignment="Top" >
            <winui:NumberBox x:Name="rWood" x:FieldModifier="public" Style="{StaticResource RightAlignNumberBox}"
                              NumberFormatter="{x:Bind cotg:App.formatterInt,Mode=OneTime}"                          
                          Header="Wood k/h" Width="80" Margin="4" TextAlignment="Right" />
            <winui:NumberBox x:Name="rStone" x:FieldModifier="public" Style="{StaticResource RightAlignNumberBox}"
                             NumberFormatter="{x:Bind cotg:App.formatterInt,Mode=OneTime}"
                          Header="Stone k/h" Width="80" Margin="4" TextAlignment="Right" />
            <winui:NumberBox x:Name="rIron" x:FieldModifier="public" Style="{StaticResource RightAlignNumberBox}"
                             NumberFormatter="{x:Bind cotg:App.formatterInt,Mode=OneTime}"
                          Header="Iron k/h" Width="80" Margin="4" TextAlignment="Right" />
            <winui:NumberBox x:Name="rFood" x:FieldModifier="public" Style="{StaticResource RightAlignNumberBox}"
                             NumberFormatter="{x:Bind cotg:App.formatterInt,Mode=OneTime}"
                          Header="Food k/h" Width="80" Margin="4" TextAlignment="Right" />
            <winui:NumberBox x:Name="rGold" x:FieldModifier="public" Style="{StaticResource RightAlignNumberBox}"
                             NumberFormatter="{x:Bind cotg:App.formatterInt,Mode=OneTime}"
                          Header="Gold k/h" Width="80" Margin="4" TextAlignment="Right" />
        </StackPanel>
        
        <tg:RadDataGrid x:Name="cityGrid"
                        ColumnResizeHandleDisplayMode="OnColumnHeaderActionFlyoutOpen"
                        ColumnDataOperationsMode="Flyout"
                        Grid.Row="0"
                        Margin="0,56,0,0"
                IsTabStop="True"
                      
                        UserGroupMode="Auto"
                        AlternationStep="2"
                        ItemsSource="{x:Bind game:City.gridCitySource, Mode=OneWay}"
                        AutoGenerateColumns="False"
                        SelectionMode="Extended"
                        CanUserChooseColumns="True"
                        RowHeight="{StaticResource GridRowHeight}"
                        UserFilterMode="Auto"
                        PointerPressed="CityGrid_PointerPress"
                        PointerExited="cityGrid_PointerExited"
                        FontSize="{StaticResource MediumFontSize}"
                        GroupPanelPosition="Bottom"
                        SelectionUnit="Row">
           
            <tg:RadDataGrid.Commands>
         
                <model:CityGridToggleColumnVisibilityCommand />
            </tg:RadDataGrid.Commands>
            <tg:RadDataGrid.Columns>
                <tg:DataGridImageColumn PropertyName="icon"
                                        Header="I"
                                        SizeMode="Fixed"
                                        IsCellFlyoutEnabled="True" Tip="Click to switch to this city" 
                                        Width="34" />
                <tg:DataGridTextColumn PropertyName="nameAndRemarks"
                                       Tip="Click to raid from this city without switching cities (faster)"
                                       IsCellFlyoutEnabled="True"
                                       Header="Name"
                                       CellContentStyle="{StaticResource LeftAlign}"
                                       SizeMode="Auto"
                                       Width="100" />
                <tg:DataGridTextColumn PropertyName="xy"
                                       CellContentStyle="{StaticResource CenterAlignLink}"
                                       Width="80" />
                <tg:DataGridNumericalColumn PropertyName="cont"
                                       SizeMode="Fixed"
                                       CellContentStyle="{StaticResource CenterAlign}"
                                       Width="42" />
                <tg:DataGridNumericalColumn PropertyName="tsTotal"
                                            CellContentStyle="{StaticResource RightAlign}"
                                        IsCellFlyoutEnabled="True" Tip="TS enlisted in city" 
                                            CellContentFormat="{}{0,7:N0}"
                                       Width="80" />
                <tg:DataGridNumericalColumn PropertyName="tsRaid" CellContentStyle="{StaticResource RightAlign}"
                        CellContentFormat="{}{0,7:N0}" Width="80"
                      IsCellFlyoutEnabled="True" Tip="TS of Troops at home that can raid" 
/>
                <tg:DataGridNumericalColumn PropertyName="tsHome"
                                            CellContentStyle="{StaticResource RightAlign}"
                      IsCellFlyoutEnabled="True" Tip="TS of Troops at home (including non raiding troops)" 
                                            CellContentFormat="{}{0,7:N0}" Width="80" IsVisible="False" />
                <tg:DataGridNumericalColumn PropertyName="raidReturn"
                                           IsCellFlyoutEnabled="True" Tip="Click here to bring troops home rapidly"
                                            CellContentStyle="{StaticResource RightAlignLink}"
                                            CellContentFormat="{}{0,6:N0}"
                                            
                                            Width="50" />
                <tg:DataGridNumericalColumn PropertyName="raidCarry"
                                           IsCellFlyoutEnabled="True" Tip="% of loot carried per raid.  When this drops below 70 it might be time to reset this raid.  Click here to bring troops home when their next raid completes"  CellContentStyle="{StaticResource RightAlignLink}"
                                            CellContentFormat="{}{0,5:N1}"
                                            Width="80"
                                             />
                <tg:DataGridNumericalColumn PropertyName="points"
                                           IsCellFlyoutEnabled="True" Tip="City score"
                                            CellContentStyle="{StaticResource RightAlign}"
                                            CellContentFormat="{}{0,6:N0}"
                                            Width="80" />
                <tg:DataGridTextColumn PropertyName="remarks"
                                       CellContentStyle="{StaticResource LeftAlign}"
                                       Width="60"
                                       IsVisible="False" />
                <tg:DataGridTextColumn PropertyName="senny"
                                       CellContentStyle="{StaticResource LeftAlign}"
                                       Width="40"
                                       IsVisible="False" />
                <tg:DataGridBooleanColumn PropertyName="isCastle"
                                          IsVisible="False"
                                          Width="40" />
                <tg:DataGridBooleanColumn PropertyName="isOnWater"
                                          IsVisible="False"
                                          Width="40" />
                <tg:DataGridNumericalColumn PropertyName="carryCapacity"
                                            CellContentStyle="{StaticResource RightAlign}"
                                            CellContentFormat="{}{0,8:N0}"
                                            IsVisible="False"
                                            Width="80" />
                <tg:DataGridNumericalColumn PropertyName="activeCommands"
                                            CellContentStyle="{StaticResource RightAlign}"
                                            CellContentFormat="{}{0,2:N0}"
                                            IsVisible="False"
                                            Width="40" />
                <tg:DataGridNumericalColumn PropertyName="commandSlots"
                                            CellContentStyle="{StaticResource RightAlign}"
                                            CellContentFormat="{}{0,2:N0}"
                                            IsVisible="False"
                                            Width="40" />
            </tg:RadDataGrid.Columns>
          
        </tg:RadDataGrid>
        <StackPanel Orientation="Horizontal" Grid.Row="1" Margin="4,0,0,0" Height="64" VerticalAlignment="Top">
            <ComboBox x:Name="raidCarryBox" Header="Carry%" SelectionChanged="RaidCarrySelChanged"
                  Width="200" IsEditable="True" TextSubmitted="RaidCarrySubmitted" Margin="2"
                />
            <winui:DropDownButton x:Name="includeButton" Content="Include" Margin="6" Click="IncludeButtonClick" VerticalAlignment="Bottom" Style="{ThemeResource DropDownButtonRevealStyle}" />
            <winui:NumberBox  x:Name="raidFraction" Header="Use fraction" Margin="6,0,4,0" Value="{x:Bind game:Raiding.troopFraction,Mode=TwoWay}" NumberFormatter="{x:Bind cotg:App.formatter2Digit,Mode=OneTime}" ValueChanged="RaidFraction_ValueChanged" SmallChange=".0625" SpinButtonPlacementMode="Compact" Width="200" />
        </StackPanel>
        <tg:RadDataGrid x:Name="dungeonGrid"
                        Margin="0,58,0,0"
                        AlternationStep="2"
                        UserGroupMode="Disabled"
                        AutoGenerateColumns="False"
                        SelectionMode="Single"
                        RowHeight="{StaticResource GridRowHeight}"
                        FontSize="{StaticResource MediumFontSize}"
                        Grid.Row="1"
                        CanUserChooseColumns="True"
                        UserSortMode="Single"
                        SelectionUnit="Row"
                        ColumnResizeHandleDisplayMode="OnColumnHeaderActionFlyoutOpen"
                                    ColumnDataOperationsMode="Flyout"
                       >
            
            <tg:RadDataGrid.Commands>
                <model:DungeonTapCommand />
            </tg:RadDataGrid.Commands>
            <tg:RadDataGrid.Columns>
                <tg:DataGridNumericalColumn PropertyName="dist" CellContentStyle="{StaticResource RightAlign}" IsCellFlyoutEnabled="True" Tip="Distance to dungeon" />
                <tg:DataGridTextColumn PropertyName="plan" CellContentStyle="{StaticResource RightAlignLink}" IsCellFlyoutEnabled="True" Tip="Click here to send raids" />
                <tg:DataGridNumericalColumn PropertyName="level" CellContentStyle="{StaticResource RightAlign}"/>
                <tg:DataGridNumericalColumn PropertyName="completion"
                                            IsCellFlyoutEnabled="True" Tip="How worn out the dungeon is.  When this reaches 0 the dungeon disappears and troops stop raiding.  Prefering dungeons with lower completion is a way to prevent raid carry from falling too far, a form of auto reseting raids"
                                            CellContentFormat="{}{0,6:N1}" CellContentStyle="{StaticResource RightAlign}" />
                <tg:DataGridTextColumn PropertyName="kind" CellContentStyle="{StaticResource RightAlign}"/>
                <tg:DataGridTextColumn PropertyName="xy" CellContentStyle="{StaticResource CenterAlignLink}"  />
            </tg:RadDataGrid.Columns>
        </tg:RadDataGrid>
        <tk:GridSplitter Grid.Row="1"
                         ResizeDirection="Rows"
                                                 Height="11"
                         HorizontalAlignment="Stretch"
                         VerticalAlignment="Top"
                           Background="Transparent"
                    >
            <tk:GridSplitter.Element>
                <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE76F;"
                     IsHitTestVisible="False"    />
            </tk:GridSplitter.Element>
        </tk:GridSplitter>
        <winui:TeachingTip x:Name="TipRaiding101" x:FieldModifier="public"
                                Title="Raiding 101"
                                Target="{x:Bind cityGrid}"
                                CloseButtonClick="TipRaiding101_ActionButtonClick"
                               CloseButtonContent="Got It"
                           PreferredPlacement="LeftTop"
                                Subtitle="Select a city and recommended raids will appear in the tab below">
                <TextBlock  TextWrapping="Wrap">
                The 'tsRaid' column header will sort your cities by TS at home, allowing you to see which cities have the most idle troops.<LineBreak/>
                Note: Click the column twice to sort in descending order<LineBreak/>
                </TextBlock>
        </winui:TeachingTip>
            
            <winui:TeachingTip x:Name="TipRaiding102" x:FieldModifier="public"
                                Title="Dungeons 101"
                               CloseButtonContent="Success"
                            PreferredPlacement="LeftTop"
                                Target="{x:Bind dungeonGrid}"
                                Subtitle="Click on a dungeon that you would like to send raids to.">
            <TextBlock  TextWrapping="Wrap">                    
                Click the 'plan' cell to dispatch raids
                <LineBreak/>You typically want to select a dungeon appropriate for your troop type:
                    <LineBreak/>    -   Mountain for Infantry
                    <LineBreak/>    -   Hills for Magic
                    <LineBreak/>    -   Forests for Cavalry
                    <LineBreak/> Appropriate dungeons will be shown first unless they are far away
            </TextBlock>
        </winui:TeachingTip>
        <winui:TeachingTip x:Name="TipRaiding201" x:FieldModifier="public"
                                Title="Home Please"
                                Target="{x:Bind cityGrid}"
                                CloseButtonClick="TipRaiding201_ActionButtonClick"
                               CloseButtonContent="Thank You"
                           PreferredPlacement="Left" >
            <TextBlock TextWrapping="Wrap">
                    <LineBreak/>The 'raidReturn' column tells you when (in minutes) the city raiders will reach their current destination.
                    <LineBreak/>    -   If the number is positive, they are returning
                    <LineBreak/>    -   If negative, they are on their way to the dungeon
                    <LineBreak/>    -   999 means that there are no raids 
                    <LineBreak/>If you right-click on a city, you will see the commands 'Home Please' and 'End Raids'
                    <LineBreak/>    -   If raiders are returning from a dungeon, 'Home Please' and 'End Raids' are the same.
                    <LineBreak/>    -   If the raiders are on their way to a dungeon, 'Home Please' will tell them to come home immediately, without loot.
                    <LineBreak/>    -   'End Raids' will tell them to complete the current raid, bring home the loot and then wait at home, watching TV and eating pizza until you order them out.</TextBlock>
        </winui:TeachingTip>
        <winui:TeachingTip x:Name="TipRaiding202"
                                Title="Shortcuts Please, Whenever"
                                Target="{x:Bind cityGrid}"
                                CloseButtonClick="TipRaiding202_ActionButtonClick"
                               CloseButtonContent="Thank You"
                           PreferredPlacement="Left" >
            <TextBlock TextWrapping="Wrap">
                     Clicking on the "Raid Return" cell of city is a shortcut for issuing the 'Home Please' context action<LineBreak/>
                     Clicking on the "Carry Capacity" cell of city is a shortcut for issuing the 'End Raids' context action<LineBreak/>
                     If the "Raid Return" is negative and close to 0, the raiders just left<LineBreak/>
                    If you ask them to return "Home Please" they might teleport home instantly for you through various small temporary personal portals</TextBlock>
        </winui:TeachingTip>
        <winui:TeachingTip x:Name="TipRaiding203"
                           x:FieldModifier="public"
                                Title="Multiple Selection"
                                Target="{x:Bind cityGrid}"
                               CloseButtonContent="Good to Know"
                           PreferredPlacement="LeftBottom" >
            <TextBlock  TextWrapping="Wrap">
                     You can select multiple cities to issue commands to all selected<LineBreak/>
                     Use ctrl-click, shift-click, ctrl-a or arrows and the spacebar to select cities<LineBreak/>
                     When not pressing shift or control, be careful where you click.
                <LineBreak/>    -   Some cells might issue commands
                <LineBreak/>    -   It is safest to click on cells that are not colored to minimize unexpected actions
                <LineBreak/>    -   Adept use of the control key can help as nothing <Italic>should</Italic> happen other than selection when shift or control are pressed
                <LineBreak/>    -   Example:  Select a citylist in the box at the top of the cities grid
                <LineBreak/>        -   Give the city grid keyboard focus (tap on a city name)
                <LineBreak/>        -   Press ctrl-a to select all
                <LineBreak/>        -   Right click on a city and issue 'Return Whenever'</TextBlock>
        </winui:TeachingTip>
        <winui:TeachingTip x:Name="TipRaiding301"
                           x:FieldModifier="public"
                                Title="Carry Capacity"
                                Target="{x:Bind cityGrid}"
                               CloseButtonContent="Done with tips"
                           PreferredPlacement="LeftBottom" >
            <TextBlock TextWrapping="Wrap">
                Lower carry capacities result in more raiding losses, while carry capacities above 100 provide less income.<LineBreak/>
                As dungeons progress, their availalbe loot per raid goes up, and so does the number of monsters encountered per raid
                <LineBreak/>        -   The net effect is that carry capacity goes down over time
                <LineBreak/>An approach to balance raiding losses vs returns is to start raids at around 115% carry capactiy, and reset them when they drop below 70%.
                <LineBreak/>    Example:
                <LineBreak/>    -   Set the target carry capacity to 115%                
                <LineBreak/>    -   During a moment of enthusiasm
                <LineBreak/>        -   Sort all raids by carry capacity
                <LineBreak/>        -   select all below 70 and bring them home
                <LineBreak/>You have to got out in 30 minutes
                <LineBreak/>    -   Return all cities with "Raid Return" in the range of -20 .. 30
                <LineBreak/>    -   Use "Home Please" to return raids that:
                <LineBreak/>        -  Have started within the last 20 minutes, or
                <LineBreak/>        -  Will return within the next 30 minutes
                <LineBreak/>Alternatively, use "End Raids" to ask raiders to complete thier raids before returning
</TextBlock>
        </winui:TeachingTip>
    </Grid>
</view:UserTab>
